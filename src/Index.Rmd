---
title: "Concepts of multilevel, longitudinal, and mixed models: Group 3"
author: 
  - "Robrecht Van Der Bauwhede"
  - "Renée Blanckaert Group"
  - "Charlotte Vercammen Group"
  - "Raïsa Carmen"
date: "9-4-2022"
output: bookdown::pdf_document2
---

```{r setup, include=FALSE}
library(tidyverse)
library(kableExtra)
library(here)
library(haven) #to read sas data
library(lme4)# http://lme4.r-forge.r-project.org/book/
library(nlme)
library(cowplot)
knitr::opts_chunk$set(echo = TRUE)

data <- read_sas(sprintf("%s/data/mmse.sas7bdat",here())) %>%
  mutate(id = as.factor(id),
         NEURO = recode_factor(as.factor(NEURO), "0" = "not neuro-psychiatric", 
                              "1" = "neuro-psychiatric"),
         housing = recode_factor(as.factor(housing), "1" = "alone",
                                 "2" = "with family or partner", 
                                 "3" = "nursing home")) 

```

# Introduction
The data set results from a longitudinal observational study, the aim of which is to
study the post-operative evolution of the cognitive status of elderly hipfracture patients and their pre-operative
cognitive status, and to study the effects of housing situation and age on these evolutions.
The physical ability is measured using the MMSE (Mini Mental State Examination) score, with values between 0
and 30, where low values correspond to a bad cognitive condition, while high scores correspond to high cognitive
condition of the patient. The pre-operative cognitive status is measured through the so-called ‘neuro-status’
which is a binary indicator for being neuro-psychiatric.

- id: patient identification number
- age: age of the patient at entry
- neuro: neuro-psychiatric status of the patient (1: neuro-psychiatric, 0: not neuro-psychiatric)
- mmse: MMSE score
- time: day after operation at which the MMSE score has been measured (1, 3, 5, 8, or 12)
- housing: the housing situation prior to the hip fracture (1: alone, 2: with family or partner, 3: nursing
home)


# Data exploration

Considering the completeness of the data, it can be observed that `r n_distinct(data[is.na(data$housing),"id"])` persons' housing situation is unknown. Additionally, there was some dropout over time as show in Table \@ref(tab:EDAdropout). The column "Nb" shows the number of respondent at each time instance. The column "Return" shows the number of respondents that participated at time $t$ while they did not participate at time $t-1$; there is, for instance, one respondent that did not participate at $time = 1$ while he did participate at $time = 3$. The column "Dropout" shows the number of respondents that did not participate at time $t$ while they did participate at time $t-1$. It can be seen than many drop out at $time = 12$. The other columns show how the patient characteristics change over time as patients are added or lost from the study. Overall, there is not much variation which might indicate that the dropout of patients is not related to MMSE or patient characteristics. We will thus assume dropout is completely random.

```{r EDAdropout, echo = F}
data %>% group_by(time) %>%
  summarize(nb = n_distinct(id),
            avgage = mean(age),
            avgneuro = 100*mean(NEURO == "neuro-psychiatric"),
            avgalone = 100*mean(!is.na(housing) & housing == "alone"),
            avgfp = 100*mean(!is.na(housing) & housing == "with family or partner"),
            avgnurse = 100*mean(!is.na(housing) & housing == "nursing home"),
            avgna = 100*mean(is.na(housing))) %>%
  ungroup() %>%
  mutate(return = ifelse(time == 3,
                            sum(!(unlist(unique(data[data$time == 3, 'id'])) %in% unlist(unique(data[data$time == 1, 'id'])))),
                            ifelse(time == 5,
                                   sum(!(unlist(unique(data[data$time == 5, 'id'])) %in% unlist(unique(data[data$time == 3, 'id'])))), 
                                   ifelse(time == 8,
                                          sum(!(unlist(unique(data[data$time == 8, 'id'])) %in% unlist(unique(data[data$time == 5, 'id'])))),
                                          ifelse(time == 12,
                                                 sum(!(unlist(unique(data[data$time == 15, 'id'])) %in% unlist(unique(data[data$time == 12, 'id'])))),
                                                 0)))),
         dropout = lag(nb,1) - nb + return) %>%
  replace_na(list(dropout = 0)) %>% 
  dplyr::select(time, nb, return, dropout, avgage, avgneuro, avgalone, avgfp, 
                avgnurse, avgna) %>%
  kable(col.names = c("Time", "Nb", "Return", "Dropout", "Mean age", 
                      "% neuro-psychiatric", "%alone", "%family/ partner", 
                      "%nursing home", "%NA"),
        digits = 2,
        caption = "Dropout and patient characteristics over time.",
        booktabs = T) %>%
  kable_styling() %>%
  add_header_above(c(" " = 6, "Housing" = 4)) %>%
  column_spec(1:5, width = "0.8cm") %>%
  column_spec(6, width = "1.4cm") %>%
  column_spec(7, width = "1.2cm") %>%
  column_spec(8:9, width = "1.45cm") %>%
  column_spec(10, width = "0.8cm") 
```


Figure \@ref(fig:EDAMMSEtime) shows the average evolution of MMSE over time (Loess curves) for groups of patients with different housing and/or neuro-psychiatric status. Patients that are not neuro-psychiatric seem to have higherMMSE that stays reasonably constant over time (except for nursing home patients). MMSE seems to go up over time for nursing home patients (but they are the smallest group), and down for neuro-spychiatric patients that live with their family or partner (or unknown housing). MMSE for neuro-psychiatric patients that live alone might have a quadratic evolution over time. 

```{r EDAMMSEtime, echo = FALSE, message= FALSE, warning = FALSE, fig.cap = "MMSE over time for all patient profiles, including smoothed curves."}
ggplot(data) + 
  geom_point(aes(x = time, y = mmse, color = housing, shape = NEURO)) +
  geom_smooth(aes(x = time, y = mmse, color = housing, linetype = NEURO),
              alpha = 0, method = "loess") +
  ylim(0, 31) +
  theme_bw()
```

Figure \@ref(fig:EDApatientprofiles) shows all patient profiles.  There is quite a lot of variation between the patients' evolution. The non-psychiatric patients are also under-represented (except in the nursing home group).

```{r EDApatientprofiles, echo = FALSE, message= FALSE, warning = FALSE, fig.cap = "Patient profiles of MMSE over time."}
A <- data %>% group_by(housing, NEURO) %>%
  summarize(n = n_distinct(id)) %>%
  filter(!is.na(housing)) %>%
  ungroup() %>%
  mutate(label = sprintf("n = %.0f",n))
ggplot() + 
  geom_line(data = data[!is.na(data$housing),],
            aes(x = time, y = mmse, group = id)) +
  geom_text(data = A, x = 10, y = 32, aes(label = label)) +
  facet_grid(rows = vars(NEURO), cols = vars(housing)) +
  ylim(0, 35) +
  scale_x_continuous(breaks = c(1,3,5,8,12), labels = c(1,3,5,8,12)) +
  theme_bw() 
```

The last variable that is explored, is the age. The loess curves in Figure \@ref(fig:EDAage) show that age might be negatively correlated with MMSE.

```{r EDAage, echo = FALSE, message= FALSE, warning = FALSE, fig.cap = "MMSE versus age. Facets show the time instances."}
ggplot(data) + 
  geom_point(aes(x = age, y = mmse, color = housing, shape = NEURO)) +
  geom_smooth(aes(x = age, y = mmse)) +
  facet_wrap(vars(as.factor(time)), nrow = 2) +
  ylim(0, 31) +
  theme_bw() 
```

## Variance analysis and correlation structure

Figure \@ref(fig:EDAvar) shows that the variance is larger for the neuro-psychiatric patients (the smallest group).


```{r EDAvar, echo = FALSE, message= FALSE, warning = FALSE, fig.cap = "Error bars with 95% confidence intervals."}
datasummary <- data %>%
  group_by(NEURO, time) %>%
  summarize(mean = mean(mmse),
            var = var(mmse),
            n = n(),
            lci95 = mean - qnorm(.975)*sqrt(var)/sqrt(n),
            uci95 = mean + qnorm(.975)*sqrt(var)/sqrt(n)
            ) %>%
  ungroup()
ggplot(datasummary) + 
  geom_errorbar(aes(x = time, ymin = lci95, ymax = uci95)) +
  geom_line(aes(x = time, y = mean)) +
  facet_wrap(vars(as.factor(NEURO)), nrow = 1) +
  ylim(0, 31) +
  theme_bw() 


```

Figure \@ref(fig:EDAvarmean) shows that there seems to be an inverse relationship between the mean mmse and the variance for patients with either neuro-psychiatric status.



```{r EDAvarmean, echo = FALSE, message= FALSE, warning = FALSE, fig.cap = "Error bars with 95% confidence intervals."}
p1 <- ggplot(datasummary) + 
  geom_point(aes(x = mean, y = var, color = as.factor(time), shape = NEURO)) +
  xlab('Mean mmse') + ylab("Variance mmse") +
  scale_color_discrete(name = "time") +
  theme_bw() 
```


```{r intraclasscorrelation, include = FALSE, echo =TRUE, message = FALSE, warning = FALSE}
A <- data %>% dplyr::select(id, time, mmse) %>%
  pivot_wider(names_from = id, values_from = mmse) %>%
  dplyr::select(-time) %>%
  as.data.frame()

library(psych)
ICC(A)
library("irr")
icc(A, model = "twoway",
  type = "agreement", unit = "single")
library('irrNA')
i <- iccNA(A)
```

## Conclusion exploratory analysis

The exploratory analysis has shows that the pattern of mmse over time is likely not constant or even linear. One might attempt quadratic, cubic, or logarithmic transformations of time to accommodate this. Both the level (intercept) of mmse differs quite a lot, depending on  neuro-psychiatric status, housing and age.

There seems to be high intraclass correlation???

# Methodology and results

This section, gradually develops a statistical model that seems to fit the data best. It starts with a simple model where only limited covariates are included in  \@ref(M1)

## A simple model{#M1}
This first, simple model will assume a linear relationship between mmse and $log(time)$ for each patient. The model allows for subject-specific intercepts and slopes and the neuro-psychiatric status is the only additional explanatory variable that is taken into account. 

```{r simplelinear, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
#A simple linear model
fm0 <- lm(mmse ~ time + NEURO + NEURO * time, data = data)
par(mfrow = c(2, 3))
data %>% mutate(residuals = resid(fm0),
                     fitted = fitted(fm0)) %>%
  ggplot() + geom_line(aes(x = time, y = residuals, group = id)) + 
  facet_grid(rows = vars(housing), cols = vars(NEURO)) +
  ylab('residuals') + 
  theme_bw()
#If model is appropriate, residuals should fluctuate randomly around zero. That is clearly not so.

data %>% mutate(residuals = resid(fm0),
                     fitted = fitted(fm0)) %>%
  ggplot() + geom_line(aes(x = time, y = fitted, group = id, color = NEURO)) +
  ylab('fitted value') + 
  theme_bw()
```


```{r simplemixed, include = FALSE, echo = FALSE, message = FALSE, warning = FALSE}
#only random intercept
data$logtime <- log(data$time)
fm1 <- lmer(mmse ~ logtime + NEURO + NEURO * logtime + (1|id), data = data)
data %>% mutate(residuals = resid(fm1),
                     fitted = fitted(fm1)) %>%
  ggplot() + geom_line(aes(x = time, y = residuals, group = id)) + 
  facet_grid(rows = vars(housing), cols = vars(NEURO)) +
  ylab('residuals') + 
  theme_bw()
#There already seems to be less of a pattern
data %>% mutate(residuals = resid(fm1),
                     fitted = fitted(fm1)) %>%
  ggplot() + geom_line(aes(x = time, y = fitted, group = id, color = NEURO)) +
  ylab('fitted value') + 
  theme_bw()
```

```{r simplemixed2, include = TRUE, echo = FALSE, message = FALSE, warning = FALSE}
#random intercept and slope
fm2 <- lmer(mmse ~ logtime + NEURO + NEURO * logtime + (1 + logtime|id), data = data) #boundary (singular) fit: see ?isSingular
#isSingular(fm2) #TRUE if time is used in stead of logtime!

summary(fm2)
```
```{r simplemixedresiduals, include = TRUE, echo = FALSE, message = FALSE, warning = FALSE, fig.caption = "Residuals and time."}
data %>% mutate(residuals = resid(fm2),
                     fitted = fitted(fm2)) %>%
  ggplot() + geom_line(aes(x = time, y = residuals, group = id)) + 
  facet_grid(rows = vars(housing), cols = vars(NEURO)) +
  ylab('residuals') + 
  theme_bw()
#There already seems to be less of a pattern
```

```{r simplemixedfitted, include = TRUE, echo = FALSE, message = FALSE, warning = FALSE, fig.caption = "Fitted values plotted against log(time) and time."}
p1 <- data %>% mutate(residuals = resid(fm2),
                     fitted = fitted(fm2)) %>%
  ggplot() + geom_line(aes(x = logtime, y = fitted, group = id, color = NEURO)) +
  ylab('fitted value') + 
  theme_bw() +
  xlab("log(time)")
p2 <- data %>% mutate(residuals = resid(fm2),
                     fitted = fitted(fm2)) %>%
  ggplot() + geom_line(aes(x = time, y = fitted, group = id, color = NEURO)) +
  ylab('fitted value') + 
  theme_bw()
p <- plot_grid(p1 + theme(legend.position="none"), p2 + theme(legend.position="none"), nrow = 1)
legend <- get_legend(
  p1 + theme(legend.box.margin = margin(0, 0, 0, 12))
)
plot_grid(p,legend,rel_widths = c(3,1))
```

2.Fit a linear mixed model assuming a linear evolution for the response of every subject, on a log-scale for
time (i.e., use log(t) as ‘time scale’). Allow for subject-specific intercepts as well as slopes. Compare the
average evolution of the two neuro groups. Interpret all estimated parameters.
3. Estimate the random effects, and produce a scatterplot of the estimated slopes versus the estimated
intercepts.
4.


# Conclusion
 
